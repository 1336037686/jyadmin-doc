# 基础框架设计-接口幂等

<br/>

| 版本   | 时间       | 修改点 | 修改人  |
| :----- | :--------- | :----- | :------ |
| v1.0.0 | 2022-05-25 | 编写   | LGX_TvT |
| -      | -          | -      | -       |

<br/>

## 1、概述

在网络应用中，实现接口的幂等性是非常重要的。"幂等"这个词来源于数学，当一个操作被多次执行，但结果仍然不变，那么就称这个操作是幂等的。

在分布式系统或网络应用中，由于网络的不可靠性，有可能会出现重复请求，比如用户点击提交后因为网络延迟没有反应又点击了一次，或者系统自动进行了重试。如果接口不具备幂等性，那么这些重复的请求可能会导致数据的不一致或其他的错误。

故而，实现接口的幂等性的主要理由包括：

1. **防止数据不一致**：如果一次操作对系统状态产生了改变，那么重复执行这个操作可能会导致数据不一致。实现幂等性可以防止这种情况发生。

2. **提高系统的健壮性**：网络环境的不确定性使得重复请求成为了常态。实现幂等性可以使系统对这种不确定性具有更强的抵抗能力。

3. **改善用户体验**：对用户来说，无论他们点击一次还是多次提交，他们期望的结果都是一样的。幂等性可以保证无论用户如何操作，结果都是他们期望的。

总的来说，接口的幂等性是一种对系统健壮性、数据一致性和用户体验的重要保证，特别是在分布式和网络环境中，实现接口的幂等性尤为重要。



## 2、接口幂等性的实现方式

实现接口的幂等性通常有以下几种方法：

1. **使用Token机制**：服务器端生成一个唯一的token（例如UUID），并将它发送到客户端。客户端在每次请求时都将这个token一同发送到服务器。服务器接收到请求后，检查这个token是否已经使用过。如果没有使用过，那么执行请求并将这个token标记为已使用；如果已经使用过，那么拒绝这个请求。这样就可以保证每个请求只被执行一次。

2. **乐观锁**：乐观锁是一种常见的并发控制策略，它在更新数据时会检查数据是否已经被其他操作修改过。这通常通过在数据中加入一个版本号来实现，每次更新数据时都会将版本号加一，并在更新时检查版本号是否发生改变。如果版本号已经改变，那么说明数据已经被其他操作修改过，因此拒绝这个更新请求。

3. **分布式锁**：对于分布式系统，可以使用分布式锁来保证接口的幂等性。当一个操作开始时，可以尝试获取一个锁，如果获取失败，那么说明这个操作已经在执行，因此拒绝这个操作。如果获取成功，那么执行这个操作，并在完成后释放这个锁。

4. **数据库唯一约束**：如果操作涉及到的数据具有唯一性约束（例如，用户的邮箱地址），那么可以利用数据库的唯一约束来保证幂等性。在插入或更新数据时，如果违反了唯一性约束，那么数据库会抛出一个错误，可以捕捉这个错误来拒绝重复的请求。

5. **状态机**：对于某些业务，可以通过设计状态机来保证幂等性。例如，一个订单的状态可能有"新建"、"支付中"、"已支付"等，每个状态下只允许执行特定的操作，而且每个操作都会使订单的状态发生改变。这样就可以通过检查订单的状态来决定是否允许某个操作，从而保证接口的幂等性。

在jyadmin中采用的是第一种，使用Token机制实现的接口的幂等性。







